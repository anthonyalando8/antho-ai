{% extends 'main/base.html' %}


{% block title %}
AI Assistant | SoftConnect
{% endblock %}
{% block titleOg %}
AI Assistant | SoftConnect
{% endblock %}
{% block titleWeb %}
AI Assistant | SoftConnect
{% endblock %}

{% block descriptionOg %}
Engage in dynamic conversations on SoftConnect. Interact with our AI model for instant answers and seamless communication.
{% endblock %}
{% block descriptionWeb %}
Engage in dynamic conversations on SoftConnect. Interact with our AI model for instant answers and seamless communication.
{% endblock %}
{% block header %} SoftChatAI {% endblock %}
{% block body-color %}
bg-dark
{% endblock %}
{% block content %}
{% load custom_filters %}

<style>
    .top-section{
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
        word-wrap: break-word;
        overflow-y: scroll;
        min-height: calc(100% - 98px)!important;
        max-height: calc(100% - 98px)!important;
    }
    .top-section::-webkit-scrollbar {
        display: none;
    }
    textarea {
        resize: none; /* Disable manual resizing */
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
        max-height: 10vh;
    }
    textarea::-webkit-scrollbar {
        display: none;
    }
    input[type="file"] {
        display: none;
    }
    label{
        cursor: pointer;
    }
    
</style>


<div class="h-100 mx-auto" id="chat-container">
    
    <div class="top-section position-relative"id="top">
        <div  id="chat">
            {% for chat in default %}
                    <div class=" rounded m-2 p-1 text-light" id="prompt_{{ chat.request_id }}">
                        {{ chat.message | prepend_username:user | convert_to_markdown|safe }}
                        <div class="m-1 overflow-hidden" style="max-width: 500px; max-height: 500px;">
                            {% if chat.image %}
                                <img src="{{ chat.image.url }}" class="img-fluid rounded" alt="Image message">
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class=" rounded m-2 p-1 text-light" id="response_{{ chat.request_id }}">
                        {{ chat.response | prepend_gemini | convert_to_markdown |safe }}
                    </div>
            {% endfor%}
        </div>
        <div class="position-fixed end-0" style="bottom: 98px;">
            <button class="btn btn-success text-light m-2 bg-transparent" id="adjust-chat-button"><i class="fa-solid fa-arrow-down"></i></button>
        </div>
        {% if not user.is_authenticated %}
        <div class="p-3 position-absolute top-0 start-50 translate-middle-x" style="z-index: 11">
            <div id="liveToast" class="toast" data-bs-autohide="false" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body">
                    <div class="row">
                        <div class="col-10">
                            Login to save your chat history.
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Initialize the toast -->
        <script>
            $(document).ready(function(){
                $('.toast').toast('show');
            });
        </script>
        
         {% endif %}
    </div>
    
    <div class="bg-transparent m-2 border rounded-pill ps-3 pe-3" id="chat-form">
        <form method="post" id="form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group ">
                <span class="input-group-text bg-transparent border-0" id="basic-addon1">
                    <label for="id_image" class="text-light bg-transparent" id="lbl-upload-image">
                        <i class="fa-regular fa-image"></i>
                    </label>
                    {{ form.image }}
                </span>
                {{ form.message }}
                <button type="submit" id="btn-submit"class="btn text-light btn-block disabled"><i class="fa-solid fa-paper-plane "></i></button>
            </div>
        </form>  
    </div>
</div>
<script>
    // myapp/static/script.js

    // $(document).ready(function() {
    //     $.getJSON('/chat/', function(data) {
    //         console.log("data:", data);
    //     });
    // });

</script>
<script>
    $('#id_message').on('input', function() {
        var text = $(this).val().trim(); // Trim to remove whitespace
        if (text === '') {
            $('#btn-submit').addClass('disabled');
        } else {
            $('#btn-submit').removeClass('disabled');
        }
    });
    function adjustChatContainer() {
        $("#chat-container").addClass("w-75");
        $(window).resize(function(){
            var viewportWidth = $(window).width();
            if (viewportWidth < 800){
                $("#chat-container").removeClass("w-75");
                $("#chat-container").addClass("w-100");
            }else{
                $("#chat-container").removeClass("w-100");
                $("#chat-container").addClass("w-75");
            }
        });
        $(window).resize();
    }

    // Call the function when the page loads
    $(document).ready(function(){
        $('#id_message').focus();
        adjustChatContainer();
        $("#adjust-chat-button").click(function() {
            $('#top').animate({
            scrollTop: $('#top')[0].scrollHeight
        }, 'slow');        
        });
        // Add change event listener to the input field
        $('#id_image').change(function(event) {
            var file = event.target.files[0];
            // Create a URL for the selected file
            var imageURL = URL.createObjectURL(file);
            // Set the created URL as the src attribute of the img tag
            $('#uploaded-img').attr('src', imageURL);
            // Show the modal
            $('#id_message').attr('placeholder', 'Add text message (Optional)')
            $('#staticBackdrop').modal('show');

        });
        $('#btn-change').click(function() {
            // Trigger click event on the file input field to open file selection dialog
            $('#lbl-upload-image').click();
        });
        $('#clear-selection').click(function() {
            $('#uploaded-img').attr('src', '');
            $('#id_image').val('');
            $('#staticBackdrop').modal('hide');
            $('#id_message').attr('placeholder','Enter message');
            $('#id_message').focus();
        });
        $('#close-modal').click(function() {
            // Trigger click event on the file input field to open file selection dialog
            $('#id_message').focus();
        });
    });

    
</script>
<script>
    $(document).ready(function() {
        $('#top').animate({
            scrollTop: $('#top')[0].scrollHeight
        }, 'slow');
        $('#id_message').keypress(function(event) {
            // Check if the Enter key is pressed
            if (event.keyCode === 13 && !event.shiftKey) {
                event.preventDefault();
                $('#btn-submit').click();
            }
        });
        var appendedData = '';

        $('#form').submit(function(event) {
            // Prevent the default form submission
            event.preventDefault();

            // Serialize form data
            var formData = new FormData(this);
            // Reference to the submit button
            var submitButton = $('#form button[type="submit"]');

            submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            submitButton.attr("disabled","disabled");
            var newDiv = $('<div class="border rounded m-2 p-1 bg-light"></div>');
            // Clear form fields
            $('#form')[0].reset();

            // Send an AJAX request
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Update the content of a div with the new data
                    console.log(response);
                    submitButton.html('<i class="fa-solid fa-paper-plane"></i>');
                    submitButton.removeAttr("disabled")
                    $('#id_message').attr('placeholder','Enter message');
                    $('#id_message').focus();
                    //$('#chat').html(response.html);
                    appendedData = '';
                },
                error: function(error) {
                    submitButton.html('<i class="fa-solid fa-paper-plane"></i>');
                    submitButton.removeAttr("disabled")
                    console.log(error);
                },
                xhrFields: {
                onprogress: function(event) {
                        // Append the new data as it's being streamed
                        var newData = event.target.responseText.substring(appendedData.length);
                        newDiv.append(newData);
                        $('#chat').append(newData);
                        $('#top').scrollTop($('#top')[0].scrollHeight);
                        appendedData += newData;
                    }
                }
            });
        });
    });
</script>
    
    
{%endblock%}